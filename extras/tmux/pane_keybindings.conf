# vim:ft=tmux:
%hidden vim_pattern='(\S+/)?g?\.?(view|l?n?vim?x?|fzf)(diff)?(-wrapped)?'
%hidden is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +${vim_pattern}$'"

# move tmux-pane/terminal-window
bind-key -n 'C-h' if-shell "$is_vim" {send-keys C-h} {
    if-shell 'test -n "$KITTY_LISTEN_ON"' {
        if-shell -F '#{pane_at_left}' {
            run-shell -b "kitten @ focus-window --match neighbor:left --no-response"
        } {select-pane -L}
    } {if-shell -F '#{pane_at_left}' {} {select-pane -L}}
}
bind-key -n 'C-j' if-shell "$is_vim" {send-keys C-j} {
    if-shell 'test -n "$KITTY_LISTEN_ON"' {
        if-shell -F '#{pane_at_bottom}' {
            run-shell -b "kitten @ focus-window --match neighbor:bottom --no-response"
        } {select-pane -D}
    } {if-shell -F '#{pane_at_bottom}' {} {select-pane -D}}
}
bind-key -n 'C-k' if-shell "$is_vim" {send-keys C-k} {
    if-shell 'test -n "$KITTY_LISTEN_ON"' {
        if-shell -F '#{pane_at_top}' {
            run-shell -b "kitten @ focus-window --match neighbor:top --no-response"
        } {select-pane -U}
    } {if-shell -F '#{pane_at_top}' {} {select-pane -U}}
}
bind-key -n 'C-l' if-shell "$is_vim" {send-keys C-l} {
    if-shell 'test -n "$KITTY_LISTEN_ON"' {
        if-shell -F '#{pane_at_right}' {
            run-shell -b "kitten @ focus-window --match neighbor:right --no-response"
        } {select-pane -R}
    } {if-shell -F '#{pane_at_right}' {} {select-pane -R}}
}

# resize tmux-pane/terminal-window
bind-key -n 'C-M-h' if-shell "$is_vim" {send-keys C-M-h} {
    if-shell 'test -n "$KITTY_LISTEN_ON"' {
        if-shell -F '#{pane_at_right}' {
            if-shell -b "kitten @ ls --match neighbor:right" {
                run-shell -b "kitten @ resize-window --axis horizontal --increment -3"
            } {
                if-shell -F '#{pane_at_left}' {
                    if-shell -b "kitten @ ls --match neighbor:left" {
                        run-shell -b "kitten @ resize-window --axis horizontal --increment 3"
                    }
                } {resize-pane -L 3}
            }
        } {resize-pane -L 3}
    } {resize-pane -L 3}
}
bind-key -n 'C-M-j' if-shell "$is_vim" {send-keys C-M-j} {
    if-shell 'test -n "$KITTY_LISTEN_ON"' {
        if-shell -F '#{pane_at_bottom}' {
            if-shell -b "kitten @ ls --match neighbor:bottom" {
                run-shell -b "kitten @ resize-window --axis vertical --increment 1"
            } {
                if-shell -F '#{pane_at_top}' {
                    if-shell -b "kitten @ ls --match neighbor:top" {
                        run-shell -b "kitten @ resize-window --axis vertical --increment -1"
                    }
                } {resize-pane -D 1}
            }
        } {resize-pane -D 1}
    } {resize-pane -D 1}
}
bind-key -n 'C-M-k' if-shell "$is_vim" {send-keys C-M-k} {
    if-shell 'test -n "$KITTY_LISTEN_ON"' {
        if-shell -F '#{pane_at_bottom}' {
            if-shell -b "kitten @ ls --match neighbor:bottom" {
                run-shell -b "kitten @ resize-window --axis vertical --increment -1"
            } {
                if-shell -F '#{pane_at_top}' {
                    if-shell -b "kitten @ ls --match neighbor:top" {
                        run-shell -b "kitten @ resize-window --axis vertical --increment 1"
                    }
                } {resize-pane -U 1}
            }
        } {resize-pane -U 1}
    } {resize-pane -U 1}
}
bind-key -n 'C-M-l' if-shell "$is_vim" {send-keys C-M-l} {
    if-shell 'test -n "$KITTY_LISTEN_ON"' {
        if-shell -F '#{pane_at_right}' {
            if-shell -b "kitten @ ls --match neighbor:right" {
                run-shell -b "kitten @ resize-window --axis horizontal --increment 3"
            } {
                if-shell -F '#{pane_at_left}' {
                    if-shell -b "kitten @ ls --match neighbor:left" {
                        run-shell -b "kitten @ resize-window --axis horizontal --increment -3"
                    }
                } {resize-pane -R 3}
            }
        } {resize-pane -R 3}
    } {resize-pane -R 3}
}

bind-key -T copy-mode-vi 'C-h' if -F '#{pane_at_left}'    {} {select-pane -L}
bind-key -T copy-mode-vi 'C-j' if -F '#{pane_at_bottom}'  {} {select-pane -D}
bind-key -T copy-mode-vi 'C-k' if -F '#{pane_at_top}'     {} {select-pane -U}
bind-key -T copy-mode-vi 'C-l' if -F '#{pane_at_right}'   {} {select-pane -R}

# close vim-window/tmux-pane
bind-key -n 'M-ŵ' if-shell "$is_vim" {send-keys 'M-ŵ'} {kill-pane}
